<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Hub: Metadaten-Aktualisierung</title>
    <style>
        :root { 
            --bg-color: #14171a; 
            --main-color: #f1f1f1; 
            --accent-start: #4CAF50; /* Gr√ºn f√ºr Start */
            --accent-refresh: #2196F3; /* Blau f√ºr Refresh */
            --card-bg: #212529; 
            --text-color: #ffffff; 
            --error-color: #f44336;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            margin: 0; 
            padding: 0; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        .header { 
            background-color: #000; 
            padding: 15px 20px; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.5); 
            width: 100%; 
            text-align: center; 
        }
        .logo { 
            color: var(--main-color); 
            font-size: 1.5em; 
            font-weight: bold; 
        }
        .content { 
            padding: 40px 20px; 
            max-width: 800px; 
            width: 100%; 
        }
        h1 { 
            color: var(--main-color); 
            margin-bottom: 30px; 
            text-align: center; 
        }
        
        #status-box {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        #status-message {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            color: var(--accent-start);
        }

        .action-button {
            padding: 12px 25px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            margin-top: 15px;
            box-sizing: border-box;
        }
        
        #startButton {
            background-color: var(--accent-start);
            color: var(--text-color);
        }

        #startButton:hover:not(:disabled) {
            background-color: #388e3c;
        }

        #startButton:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        #refreshHubButton {
            background-color: var(--accent-refresh);
            color: var(--text-color);
            display: none; /* Initial versteckt */
        }
        
        #refreshHubButton:hover {
            background-color: #1565c0;
        }

        #output-log {
            background-color: #000;
            color: #ddd;
            padding: 15px;
            border-radius: 6px;
            height: 300px;
            overflow-y: scroll;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 0.85em;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Video Hub</div>
    </div>
    
    <div class="content">
        <h1>Metadaten-Aktualisierung (Flask API)</h1>
        
        <div id="status-box">
            <div id="status-message">Status: Bereit.</div>
            
            <button id="startButton" class="action-button">
                ‚ñ∂ Metadaten-Update starten
            </button>
            
            <button id="refreshHubButton" class="action-button">
                ‚úî Update abgeschlossen - Video Hub neu laden
            </button>

            <pre id="output-log">
=========================================================
üé• Video Hub Metadaten-Scan (TMDB -> metadata.json)
=========================================================

Dieser Status-Monitor kommuniziert mit der Flask-API auf Port 5000.
Klicken Sie auf 'Starten', um den Scan im Hintergrund zu initialisieren.

Das Log wird alle 2 Sekunden aktualisiert.
            </pre>
            
        </div>
    </div>

    <script>
        const startButton = document.getElementById('startButton');
        const refreshHubButton = document.getElementById('refreshHubButton');
        const statusMessage = document.getElementById('status-message');
        const outputLog = document.getElementById('output-log');
        let updateInterval;

        // Definiere die API-Basis-URL explizit mit Port 5000, um den CORS/Port-Konflikt zu vermeiden.
        const FLASK_API_BASE_URL = window.location.protocol + '//' + window.location.hostname + ':5000';
        
        // --- 1. Funktion zum Starten des Scans ---
        async function startScan() {
            startButton.disabled = true;
            startButton.textContent = 'L√§uft... Bitte warten.';
            refreshHubButton.style.display = 'none';
            statusMessage.textContent = 'Status: Update gestartet. Log wird abgerufen.';
            
            try {
                const response = await fetch(FLASK_API_BASE_URL + '/api/start_update', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'STARTED' || data.status === 'RUNNING') {
                    // Starte die regelm√§√üige Abfrage des Status und Logs
                    updateInterval = setInterval(updateStatus, 2000); 
                } else {
                    statusMessage.textContent = `Fehler beim Start: ${data.message}`;
                    startButton.disabled = false;
                    startButton.textContent = '‚ñ∂ Metadaten-Update starten';
                }
                
            } catch (error) {
                console.error('Fehler beim Start des Updates:', error);
                statusMessage.textContent = 'Fehler bei der Serverkommunikation. (Siehe Konsole)';
                startButton.disabled = false;
                startButton.textContent = '‚ñ∂ Metadaten-Update starten';
            }
        }
        
        // --- 2. Funktion zum Abrufen des Status und des Logs ---
        async function updateStatus() {
            try {
                const response = await fetch(FLASK_API_BASE_URL + '/api/status');
                
                const contentType = response.headers.get("content-type");
                if (!response.ok || !contentType || !contentType.includes("application/json")) {
                    const text = await response.text(); 
                    throw new Error("Unerwartete Server-Antwort. Status: " + response.status + ". Antwort beginnt mit: " + text.substring(0, 50) + "...");
                }
                
                const data = await response.json();
                
                outputLog.textContent = data.log;
                outputLog.scrollTop = outputLog.scrollHeight; 
                
                if (data.status === 'RUNNING') {
                    statusMessage.textContent = 'Status: Update l√§uft...';
                } else if (data.status === 'FINISHED_OK') {
                    // FIX: Button wieder aktivieren und Interval stoppen
                    clearInterval(updateInterval);
                    statusMessage.textContent = 'Status: Update erfolgreich abgeschlossen! üéâ';
                    
                    startButton.style.display = 'block'; 
                    startButton.disabled = false;
                    startButton.textContent = '‚ñ∂ Metadaten-Update erneut starten';
                    
                    refreshHubButton.style.display = 'block';
                    
                } else if (data.status === 'FINISHED_ERROR') {
                    // Bei Fehler stoppen und Button reaktivieren
                    clearInterval(updateInterval);
                    statusMessage.textContent = 'Status: Fehler beim Update. Details im Log. ‚ùå';
                    startButton.style.display = 'block';
                    startButton.disabled = false;
                    startButton.textContent = 'Update erneut starten';
                    refreshHubButton.style.display = 'none';
                    
                } else if (data.status === 'IDLE') {
                    // Wenn der initial von IDLE aufgerufen wird, Status setzen
                    statusMessage.textContent = 'Status: Bereit. Update kann gestartet werden.';
                    startButton.style.display = 'block';
                    startButton.disabled = false;
                    refreshHubButton.style.display = 'none';
                    clearInterval(updateInterval); // Sicherstellen, dass keine Intervalle im IDLE-Zustand laufen
                }

            } catch (error) {
                clearInterval(updateInterval);
                statusMessage.textContent = 'Fehler beim Abrufen des Status. (Pr√ºfen Sie, ob Flask auf :5000 l√§uft).';
                console.error('Fehler beim Abrufen des Status:', error);
                startButton.style.display = 'block';
                startButton.disabled = false;
            }
        }

        // --- 3. Initialer Status-Check beim Laden der Seite ---
        window.onload = function() {
            // Beim Laden der Seite den aktuellen Status abrufen und die Anzeige aktualisieren
            updateStatus(); 
        }

        // Event Listener f√ºr den Start-Button
        startButton.addEventListener('click', startScan);
        
        // Event Listener f√ºr den Hub-Refresh Button (nimmt an, dass die Zielseite videohub_serien.html ist)
        refreshHubButton.addEventListener('click', () => {
             // Sie k√∂nnen hier auf Ihre Hauptseite weiterleiten
             window.location.href='/videohub_serien.html'; 
        });
    </script>
</body>
</html>